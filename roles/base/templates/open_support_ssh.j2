#!/bin/bash

# only run script as root
if [[ $(/usr/bin/id -u) -ne 0 ]]; then
    echo "Not running as root"
    exit
fi

# define variables
SSHKEYS="{{ config_tunnel_ssh_keys }}"
JITSISERVER="https://www.kuketz-meet.de"
RANDID=`openssl rand -hex 16`

# define functions
## simple yes or no function for promts
confirm() {
    # call with a prompt string or use a default
    read -r -p "$@"" [y/N]: " response
    case "$response" in
        [yY][eE][sS]|[yY])
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

## starting teamviewer and set random password
start_team_viewer() {
  TVPASSWORD=`pwgen 12 1`
  TVID=`teamviewer --info | grep "TeamViewer ID" | cut -d ':' -f2 | xargs | tr -dc '[:alnum:]\n\r' |  sed 's/0m//'`
  sudo killall /opt/teamviewer/tv_bin/TeamViewer >/dev/null 2>&1
  sleep 1
  sudo teamviewer daemon enable >/dev/null 2>&1
  export DISPLAY=":0.0" >/dev/null 2>&1
  sleep 1
  teamviewer >/dev/null 2>&1
  sudo teamviewer passwd $TVPASSWORD >/dev/null 2>&1
  # Sending access data
  /usr/local/bin/gotify "TeamViewer: $TVID $TVPASSWORD" "TeamViewer Request"
  # Echo Access Data
  echo -e "ID: $TVID\nPW: $TVPASSWORD"
}

## the screen session dump with the cloudflared tunnel gets parsed every second to find the cloudflared tunnel URL
check_for_url() {
    export TURL=""
    touch /tmp/ctun
    while [[ $TURL == "" ]]; do
    export TURL="$(cat /tmp/ctun | grep -v 'developers.cloudflare.com' | grep 'https' | cut -d '|' -f2 | sed -e 's/^[[:space:]]*//' | sed 's/https:\/\///')"
    sleep 1
    done
}

## defining cleanup function
function cleanup()
{
    # deleting all screen sessions with the name 'cloudflare_tunnel'
    screen -ls | awk -vFS='\t|[.]' '/cloudflare_tunnel/ {system("screen -S "$2" -X quit")}'
    # ensure all cloudflared tunnels are terminated
    sudo killall cloudflared >/dev/null 2>&1
    # ensure teamviewer ist shutdown
    sudo teamviewer daemon disable >/dev/null 2>&1
    # ensure temporary authorized keys are deleted
    rm -f /root/.ssh/authorized_keys_temp
    # cleanup temporary logfile from screen session dump
    rm -f /tmp/ctun
    # print message
    echo -e "\e[32mSystem access for support is now closed.\e[0m"
    sleep 2
}

######################################

# printing disclaimer
echo -e "\e[31mOpening a support request will grant $SSHKEYS temporary full system access as long as this terminal is open. A push message containing the ssh support url and optional the TeamViewer credentials will be send to support.\nOnly proceed if you absolutely trust the listed person!\e[0m\n"
if ! $(confirm 'Opening support request?') ; then
    echo "EXIT without opening request!"
    sleep 2
    exit
fi

# Proceed with support request
echo -e "Please wait until the request tunnel is initiated. [Exit with CTRL+C]"

# Make sure access is temporary - as long as script runs
## trap with cleanup function in case there is an error in the script
trap cleanup EXIT

# ensure .ssh directory
mkdir -p /root/.ssh

# Import temporary ssh keys
wget -q -O /root/.ssh/authorized_keys_temp "$SSHKEYS" &> /dev/null

# starting cloudflare tunnel in a screen session
screen -S cloudflare_tunnel -L -Logfile /tmp/ctun -d -m /usr/bin/cloudflared tunnel --url ssh://localhost:22

# getting URL from cloudflared and send via gotify
check_for_url
/usr/local/bin/gotify "cssh root@$TURL $JITSISERVER/$RANDID" "SSH Tunnel Request"

echo -e "Support request ssh channel is initalized.\n\nOpen in Browser for Meeting:\n$JITSISERVER/$RANDID\n\nAccess Endpoint for Support:\n$TURL\n\n"

# Optinal: TeamViewer
if $(confirm "Optional: Opening TeamViewer Session") ; then
    start_team_viewer
fi

echo -e "\n\n"

# wait until tunnel gets closed
read -r -p "Type ENTER to exit tunnel" response

# run cleanup
cleanup

# delete trap
trap "" EXIT
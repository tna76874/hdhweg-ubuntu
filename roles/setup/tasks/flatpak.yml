---
- name: Ensure flathub flatpak repository remotes
  flatpak_remote:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    flatpakrepo_url: "{{ item.repo }}"
  loop:
    - { repo: "https://dl.flathub.org/repo/flathub.flatpakrepo", name: "flathub", state: "present" }
    - { repo: "https://flathub.org/beta-repo/flathub-beta.flatpakrepo", name: "flathub-beta", state: "present" }

- name: Ensure verify flatpaks
  shell: "flatpak repair"
  become: yes

- name: Install flatpak packages
  flatpak:
    remote: "{{ item.repo }}"
    name: "{{ item.package }}"
    state: "{{ item.state }}"
  with_items: "{{ config_flatpak_list }}"

- name: Registering installed flatpaks
  shell: flatpak list --columns=application
  become: yes
  changed_when: false
  register: installed_flatpaks

- name: Ensure all flatpaks are up-to-date
  shell: "flatpak update -y {{ item.package }}"
  become: yes
  with_items: "{{ installed_flatpaks.stdout_lines }}"
